# Ekos Session Analyzer

Astrophotography session analyzer specialized for **Ekos/KStars**. This application analyzes `.analyze` files generated by Ekos and sends comprehensive summaries with **temporal plots** to Discord.

## ğŸŒŸ Features

### Core Features
- **Native Ekos Analysis**: Directly parses KStars/Ekos `.analyze` files
- **Temporal Plotting**: HFR, guiding error, and temperature evolution graphs
- **Advanced Analytics**: Statistical analysis with numpy/scipy (optional)
- **3 Report Levels**: minimal, standard, detailed - from quick notifications to comprehensive analysis
- **Discord Integration**: Rich summaries with emojis and organized statistics
- **Dry-Run Mode**: Safe testing without sending to Discord

### Advanced Features
- **Multi-Filter Analysis**: Performance breakdown by filter with sub-session details
- **Pixel-Scale-Based Guiding Quality**: Accurate guiding assessment based on YOUR specific equipment
- **Guiding Analytics**: Comprehensive guiding performance analysis by filter
- **Quality Metrics**: HFR, FWHM, star detection, and seeing conditions
- **Temperature Correlation**: Statistical analysis of temperature effects on imaging quality
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Alert System**: Automatic detection of performance issues and recommendations

## ğŸ“Š Report Levels

### ğŸ“± **MINIMAL** - Quick Notifications
```
**ğŸ”­ Session Summary (Minimal)**
ğŸ“¸ **31 captures completed**
â° Duration: 5h 55m

ğŸŒ¤ï¸ **Session Conditions**
ğŸŒ¡ï¸ Temperature Stability: Variable (Î”5.1Â°C)
ğŸ”­ Mount Tracking: Good (28 events)

ğŸ¯ **Autofocus Summary**
ğŸ”„ Sessions: 9
ğŸ“ˆ Focus Stability: Frequent adjustments

ğŸš¨ **4 Critical Issues**
â€¢ 4 aborted captures detected
```

### ğŸ“Š **STANDARD** - Daily Usage (Default)
```
**ğŸ”­ Ekos Session Summary**
ğŸ“… 2024-01-15 18:12 UTC

ğŸŒ™ **Session Overview**
ğŸ“¸ Total Captures: 31
â° Duration: 11:41 â†’ 17:37 (5h 55m)
ğŸŒ¡ï¸ Temperature: 15.8Â°C â†’ 20.9Â°C (avg 17.0Â°C)
ğŸ¯ Objects: 1 | ğŸ” Filters: 3 (H, O, S)

ğŸŒ¤ï¸ **Session Conditions**
ğŸŒ¡ï¸ Temperature Stability: Variable (Î”5.1Â°C)
ğŸ”­ Mount Tracking: Good (28 events)

ğŸŒŸ **Guiding Performance**
ğŸ“Š Measurements: 1,247
ğŸ¯ Avg Error: 0.92â€³
ğŸŸ¡ Guide Quality: Good
ğŸ“ˆ RA: 0.78â€³ | DEC: 0.61â€³

ğŸ“Š **Capture Details**

ğŸ¯ **NGC 7380**
ğŸ“Œ H Filter (11Ã—600s, 1h 50m)
   ğŸ”§ HFR: 3.60 â†’ 5.62 (avg 4.64, Ïƒ 0.66)
   ğŸ“ FWHM: 8.46 â†’ 13.21 (avg 10.90, Ïƒ 1.55)
   â­ Stars: 249 â†’ 250 (avg 250, consistency 1.00)
   ğŸ“ˆ Guide: 0.89â€³ ğŸŸ¡Good

ğŸ¯ **Autofocus Summary**
ğŸ”„ Sessions: 9
ğŸŒ¡ï¸ Average Temperature: 17.1Â°C
ğŸ“ˆ Focus Stability: Frequent adjustments

âš ï¸ **Issues & Alerts**
âŒ Aborted Captures: 4
```

### ğŸ”¬ **DETAILED** - Data Analysis Mode
```
**ğŸ”­ Session Overview (1/3)**
ğŸ“… 2024-01-15 18:12 UTC

ğŸŒ™ **Session Overview**
ğŸ“¸ Total Captures: 31
â° Duration: 11:41 â†’ 17:37 (5h 55m)
ğŸŒ¡ï¸ Temperature: 15.8Â°C â†’ 20.9Â°C (avg 17.0Â°C) (Stability: 60%)
ğŸ¯ Objects: 1 | ğŸ” Filters: 3 (H, O, S)

ğŸŒ¤ï¸ **Session Conditions**
ğŸŒ¡ï¸ Temperature Stability: Variable (Î”5.1Â°C)
ğŸ”­ Mount Tracking: Good (28 events)

ğŸŒŸ **Guiding Performance**
ğŸ“Š Measurements: 1,247
ğŸ¯ Avg Error: 0.92â€³
ğŸŸ¡ Guide Quality: Good
ğŸ“ˆ RA: 0.78â€³ | DEC: 0.61â€³

ğŸ“Š **Image Quality Analysis**
ğŸ”§ HFR: 1.96 â†’ 5.62 (avg 3.06)
ğŸ‘ï¸ Seeing Conditions: Average
ğŸ“ˆ HFR Stability: 0.215 (lower is better)

**ğŸ“Š Performance Analysis (2/3)**

ğŸ¯ **Filter Performance Summary**

ğŸ“Œ **H**: 11Ã—600s (1.8h) - ğŸ”§ 4.64 | ğŸ“ˆ 0.89â€³ ğŸŸ¡
ğŸ“Œ **O**: 13Ã—600s (2.2h) - ğŸ”§ 2.83 | ğŸ“ˆ 0.95â€³ ğŸŸ¡  
ğŸ“Œ **S**: 7Ã—600s (1.2h) - ğŸ”§ 2.41 | ğŸ“ˆ 0.91â€³ ğŸŸ¡

**ğŸ”¬ Detailed Sub-Sessions (3/3)**

ğŸ¯ **NGC 7380**
ğŸ“Œ H Filter (11Ã—600s, 1h 50m)
ğŸ“‹ Sub-sessions: 2
     #1: 22:46â†’23:57 (1h 10m) | 7Ã—600s
          ğŸ“ˆ Guide: 0.94â€³ ğŸŸ¡Good
          ğŸ”§ HFR: 4.12 â†’ 5.62 (avg 4.89)
          ğŸ“ FWHM: 4.94 â†’ 6.74 (avg 5.87)
         â­ Stars: 249 â†’ 250 (avg 250, consistency 1.00)
     #2: 00:15â†’00:55 (40m) | 4Ã—600s
          ğŸ“ˆ Guide: 0.81â€³ ğŸŸ¡Good
          ğŸ”§ HFR: 3.60 â†’ 4.98 (avg 4.22)
          ğŸ“ FWHM: 4.32 â†’ 5.98 (avg 5.06)
         â­ Stars: 249 â†’ 250 (avg 250, consistency 1.00)

ğŸŒ¡ï¸ **Temperature Analysis**
ğŸ“Š Thermal Stability: 60% (Range: 5.1Â°C)
ğŸ“ˆ Temp-HFR Correlation: -0.234 (significant)

ğŸ¯ **Autofocus Analysis**
ğŸ”„ Sessions: 9
ğŸ” **By Filter:**
   â€¢ H: 3 sessions (avg temp 16.8Â°C)
   â€¢ O: 4 sessions (avg temp 17.2Â°C)
   â€¢ S: 2 sessions (avg temp 17.5Â°C)
â±ï¸ Avg Interval: 45 minutes
```

## ğŸ“‹ Requirements

- Python 3.7+
- KStars/Ekos configured to generate analyze files
- Discord webhook configured
- **For DETAILED level**: NumPy/SciPy for advanced analytics
- **For plotting**: matplotlib (optional)

## ğŸ› ï¸ Prerequisites

### Installing Pipenv

This project uses **Pipenv** for dependency management. If you don't have pipenv installed, here's how to install it:

#### Ubuntu/Debian
```bash
# Method 1: Using apt (recommended for system-wide installation)
sudo apt update
sudo apt install pipenv

# Method 2: Using pip (if you prefer pip)
sudo apt install python3-pip
pip3 install --user pipenv

# Method 3: Using the official installer
curl https://raw.githubusercontent.com/pypa/pipenv/master/get-pipenv.py | python3
```

#### Other Linux Distributions
```bash
# Fedora/CentOS/RHEL
sudo dnf install pipenv
# or
sudo yum install pipenv

# Arch Linux
sudo pacman -S python-pipenv

# Using pip (universal)
pip3 install --user pipenv
```

#### Verify Installation
```bash
pipenv --version
# Should output something like: pipenv, version 2023.x.x
```

**Note for Ubuntu/Debian users**: If you installed pipenv with `pip3 install --user`, you may need to add `~/.local/bin` to your PATH:
```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

## ğŸš€ Installation

1. **Clone the repository**
```bash
git clone https://github.com/grm/ekos-session-analyzer
cd ekos-session-analyzer
```

2. **Install dependencies**
```bash
# Basic installation (minimal & standard levels)
pipenv install

# For detailed level with advanced analytics
pipenv install numpy scipy

# For temporal plots (optional)
pipenv install matplotlib
```

3. **Configure the application**
```bash
# Copy example configuration
cp config_example.yml config.yml

# Edit config.yml with your settings
```

## âš™ï¸ Configuration

### Basic Configuration

Edit the `config.yml` file:

```yaml
# Discord webhook URL (required)
webhook: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

# Time window in hours to analyze sessions
hours: 24

# Path to Ekos analyze files (optional)
# Default: ~/.local/share/kstars/analyze
analyze_dir: "/home/username/.local/share/kstars/analyze"

# Report level: minimal, standard, detailed
discord_report_level: "standard"

# Enable temporal plotting (optional)
plotting:
  enabled: true

# Log level (optional)
log_level: "INFO"
```

### ğŸ¯ Pixel Scale Configuration (HIGHLY RECOMMENDED)

**NEW FEATURE**: Configure your equipment's pixel scale for dramatically more accurate guiding quality assessment!

```yaml
# Imaging setup configuration for accurate guiding assessment
imaging_setup:
  # Pixel scale in arcseconds per pixel
  # Calculate as: (206265 Ã— pixel_size_Î¼m) Ã· (focal_length_mm Ã— binning)
  pixel_scale_arcsec: 1.0  # CHANGE THIS to match your setup
  
  # Optional: Equipment names for logging
  telescope: "Your Telescope"
  camera: "Your Camera"

# Guide quality thresholds (in pixels - much more accurate!)
alert_thresholds:
  guide_quality:
    excellent_px: 0.5    # < 0.5 pixels = Excellent
    good_px: 1.0         # < 1.0 pixels = Good  
    average_px: 1.5      # < 1.5 pixels = Average
    # > 1.5 pixels = Poor
```

#### ğŸ“ How to Find Your Pixel Scale

**Method 1: Calculate from Equipment Specs**
```
Pixel Scale = (206265 Ã— pixel_size_Î¼m) Ã· (focal_length_mm Ã— binning)
```

**Method 2: From Plate Solving Software**
- **ASTAP**: Check image solving results
- **PlateSolve2**: Look in FITS header for CDELT1/CDELT2
- **ANSVR**: Check solving logs or image properties
- **Ekos/KStars**: View solved image properties in the Image tab

**Method 3: Online Calculators**
- Use tools like AstroBin's Field of View calculator
- Enter telescope focal length and camera pixel size

#### ğŸ” Finding Equipment Specifications

**Camera Pixel Size** (common values):
- **ASI183MC/MM**: 2.4Î¼m
- **ASI294MC/MM**: 4.63Î¼m  
- **ASI2600MC/MM**: 3.76Î¼m
- **Canon 6D**: 5.36Î¼m
- **Nikon D750**: 5.95Î¼m
- **QHY600**: 3.76Î¼m

**Telescope Focal Length**:
- Check manufacturer specs or measure via plate solving
- **Celestron C8**: 2032mm (f/10), 1280mm (f/6.3 with reducer)
- **Celestron C11**: 2800mm (f/10), 1764mm (f/6.3 with reducer)  
- **FSQ85**: 450mm
- **FSQ106**: 530mm
- **Takahashi TOA150**: 1095mm

#### ğŸ“Š Common Setup Examples

```yaml
# High Resolution Setup
# Celestron C8 f/6.3 (1280mm) + ASI183MC (2.4Î¼m)
pixel_scale_arcsec: 0.39

# Medium Resolution Setup  
# FSQ85 (450mm) + ASI294MC (4.63Î¼m)
pixel_scale_arcsec: 2.12

# Wide Field Setup
# 200mm lens f/2.8 + Canon 6D (5.36Î¼m)
pixel_scale_arcsec: 5.52

# Ultra High Resolution
# C11 f/10 (2800mm) + ASI183MC (2.4Î¼m)
pixel_scale_arcsec: 0.18
```

### Advanced Options (Optional)

```yaml
# Advanced analytics (auto-enabled for detailed level)
advanced_analytics:
  enabled: false  # Set to true to force enable for standard level

# Alert thresholds (optional customization)
alert_thresholds:
  hfr_drift_warning: 0.5        # pixels
  temperature_swing_warning: 5.0 # Â°C
  success_rate_warning: 0.8     # 80%

# Notification preferences
notifications:
  performance_alerts: true
  min_captures_for_report: 1
```

## ğŸ”§ Usage

### Development and Testing
```bash
# Safe testing with dry-run (RECOMMENDED)
pipenv run python nightly_summary.py -c config.yml --dry-run

# Verbose mode for debugging
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Production Use
```bash
# Send summary to Discord
pipenv run python nightly_summary.py -c config.yml

# With verbose output
pipenv run python nightly_summary.py -c config.yml --verbose
```

### Automation
Add to your crontab for daily summary at 8 AM:
```bash
0 8 * * * cd /path/to/ekos-session-analyzer && pipenv run python nightly_summary.py -c config.yml
```

## ğŸ“Š Example Output

### Discord Message with Temporal Plot

Here's an example of what gets sent to Discord, including both the comprehensive text summary and temporal visualization:

![Example Session Plot](example_plot.png)

**Example Discord Message:**
```
ğŸ”­ Ekos Session Summary
ğŸ“… 2025-09-04 07:49 UTC

ğŸŒ™ Session Overview
ğŸ“¸ Total Captures: 7
â° Duration: 07:00 â†’ 08:38 (1h 38m)
ğŸ¯ Objects: 1 | ğŸ” Filters: 3 (H, O, S)

ğŸŒŸ Guiding Performance
ğŸ“Š Measurements: 22
ğŸ¯ Avg Error: 1.21â€³
ğŸŸ¡ Guide Quality: Good
ğŸ“ˆ RA: 0.95â€³ | DEC: 0.74â€³

ğŸ“Š Capture Details

ğŸ¯ NGC 7380
ğŸ“Œ H Filter (4Ã—600s, 58m)
   ğŸ”§ HFR: 2.75 â†’ 4.10 (avg 3.42, Ïƒ 0.67)
   ğŸ“ FWHM: 6.46 â†’ 9.63 (avg 8.05, Ïƒ 1.59)
   â­ Stars: 244 â†’ 250 (avg 247, consistency 0.99)
   ğŸ“ˆ Guide: 1.19â€³ ğŸŸ¡Good

ğŸ“Œ O Filter (2Ã—600s, 20m)
   ğŸ”§ HFR: 2.25 â†’ 2.25 (avg 2.25, Ïƒ 0.00)
   ğŸ“ FWHM: 5.29 â†’ 5.29 (avg 5.29, Ïƒ 0.00)
   â­ Stars: 247 â†’ 248 (avg 248, consistency 1.00)
   ğŸ“ˆ Guide: 1.24â€³ ğŸŸ¡Good

ğŸ¯ Autofocus Summary
ğŸ”„ Sessions: 3
ğŸ“ˆ Focus Stability: Good

âš ï¸ Issues & Alerts
âŒ Aborted Captures: 4
```

The temporal plot shows:
- **ğŸ”§ HFR Evolution**: Focus quality changes over time with autofocus events marked
- **ğŸ“ˆ Guiding Performance**: Mount tracking stability with quality zones
- **ğŸŒ¡ï¸ Temperature Evolution**: Environmental conditions during the session

## ğŸ” Troubleshooting

### No Data Found
- Verify that KStars/Ekos generates `.analyze` files in `~/.local/share/kstars/analyze/`
- Check the `analyze_dir` path in configuration
- Use `--verbose` to see detailed logs

### Discord Webhook Error
- Verify the webhook URL in `config.yml`
- Test with `--dry-run` first to see formatted output

### Advanced Analytics Issues
- For DETAILED level, install: `pipenv install numpy scipy`
- The system gracefully falls back to basic mode if dependencies are missing
- Check console output for "advanced analytics" vs "basic analytics"

### Plotting Issues
- Install matplotlib: `pipenv install matplotlib`
- Check `plotting.enabled: true` in configuration
- Plots are saved to `plots/` directory and attached to Discord messages

### Parsing Issues
- Check KStars/Ekos version (tested with 3.7.7+)
- Enable verbose mode: `--verbose`
- Use dry-run for safe testing: `--dry-run`

## ğŸ¯ Use Cases

### **Quick Monitoring** â†’ MINIMAL Level
- Essential notifications for automation
- Critical alerts only
- Perfect for mobile notifications and monitoring systems

### **Daily Usage** â†’ STANDARD Level (Default)
- Comprehensive session summaries
- All essential astrophotography metrics
- Balanced information without complexity

### **Data Analysis** â†’ DETAILED Level  
- In-depth statistical analysis with sub-sessions
- Quality and performance optimization insights
- Scientific metrics with correlation analysis
- Advanced troubleshooting information

## ğŸ”¬ Advanced Analytics (DETAILED Level)

### Automatic Features
When you select `discord_report_level: "detailed"`, the system automatically enables:

- **Sub-Session Analysis**: Detailed breakdown of each imaging run by filter
- **Statistical Correlations**: Temperature-HFR analysis with significance testing
- **Quality Scoring**: Objective analysis of session quality and conditions
- **Performance Metrics**: Success rates and filter-specific efficiency analysis
- **Trend Analysis**: HFR stability and degradation detection
- **Intelligent Alerts**: Automatic detection of issues with actionable recommendations

### Dependencies
The detailed level requires scientific Python libraries:
```bash
pipenv install numpy scipy
```

## ğŸ§ª Development

### Safe Testing
Always use dry-run mode during development:
```bash
# Test without sending to Discord
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Architecture
- **nightly_summary.py**: CLI interface and orchestration
- **ekos_analyzer.py**: Ekos .analyze file parser and data extraction
- **ekos_discord_formatter.py**: Unified Discord message formatter for all levels
- **session_plotter.py**: Temporal plot generation with matplotlib
- **advanced_metrics.py**: Statistical calculations and quality analysis
- **utils.py**: Configuration, logging, and Discord utilities

## ğŸ¤ Contributing

Contributions are welcome! The project uses:
- **Python 3.7+** with Pipenv for dependency management
- **NumPy/SciPy** for advanced analytics (optional)
- **matplotlib** for temporal plotting (optional)
- **Clear separation** between basic and advanced features with graceful degradation

## ğŸ“„ License

This project is under MIT license. See LICENSE file for details.

## ğŸ™ Acknowledgments

- KStars/Ekos team for excellent astrophotography software
- Discord community for feedback and suggestions
- NumPy/SciPy communities for statistical computing tools

## ğŸš€ Latest Updates

- **ğŸ¯ Pixel-Scale-Based Guiding Quality**: Revolutionary improvement in guiding assessment accuracy! Configure your equipment's pixel scale for meaningful quality ratings instead of misleading fixed thresholds.
- **Enhanced Multi-Filter Analysis**: Comprehensive sub-session breakdown by filter
- **Improved Guiding Analytics**: Real-time guiding performance analysis with quality assessment
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Temporal Plotting System**: HFR, guiding, and temperature evolution graphs with pixel-scale-accurate quality zones
- **Advanced Statistical Analysis**: Temperature correlations and quality metrics
- **Better Error Handling**: Graceful degradation and clear error messages
- **Unified Configuration**: Single config file supporting all features and levels

Perfect for astrophotographers from beginners to data enthusiasts! ğŸ”­âœ¨
