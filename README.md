# Ekos Session Analyzer

Astrophotography session analyzer specialized for **Ekos/KStars**. This application analyzes `.analyze` files generated by Ekos and sends comprehensive summaries with **temporal plots** to Discord.

## üåü Features

### Core Features
- **Native Ekos Analysis**: Directly parses KStars/Ekos `.analyze` files
- **Temporal Plotting**: HFR, guiding error, and temperature evolution graphs
- **Advanced Analytics**: Statistical analysis with numpy/scipy (optional)
- **3 Report Levels**: minimal, standard, detailed - from quick notifications to comprehensive analysis
- **Discord Integration**: Rich summaries with emojis and organized statistics
- **Dry-Run Mode**: Safe testing without sending to Discord

### Advanced Features
- **Multi-Filter Analysis**: Performance breakdown by filter with sub-session details
- **Pixel-Scale-Based Guiding Quality**: Accurate guiding assessment based on YOUR specific equipment
- **Guiding Analytics**: Comprehensive guiding performance analysis by filter
- **Quality Metrics**: HFR, FWHM, star detection, and seeing conditions
- **Temperature Correlation**: Statistical analysis of temperature effects on imaging quality
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Alert System**: Automatic detection of performance issues and recommendations

## üìä Report Levels

### üì± **MINIMAL** - Quick Notifications
```
**üî≠ Session Summary (Minimal)**
üì∏ **33 captures completed**
‚è∞ Duration: 7h 54m

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Moderate (Œî4.1¬∞C)

üéØ **Autofocus Summary**
üîÑ Sessions: 20
üå°Ô∏è Average Temperature: 9.0¬∞C
üìà Focus Stability: Frequent adjustments
```

### üìä **STANDARD** - Daily Usage (Default)
```
**üî≠ Ekos Session Summary**
üìÖ 2025-09-05 07:11 UTC

üåô **Session Overview**
üì∏ Total Captures: 33
‚è∞ Duration: 22:16 ‚Üí 06:11 (7h 54m)
üå°Ô∏è Temperature: 7.6¬∞C ‚Üí 11.7¬∞C (avg 8.6¬∞C)
üéØ Objects: 1 | üîç Filters: 3 (H, O, S)

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Moderate (Œî4.1¬∞C)

üåü **Guiding Performance**
üìä Measurements: 6130
üéØ Avg Error: 0.51‚Ä≥
üü° Guide Quality: Good
üìà RA: 0.38‚Ä≥ | DEC: 0.27‚Ä≥

üìä **Capture Details**

üéØ **NGC 7380**
üìå H Filter (12√ó600s, 2h 18m)
   üìà Guide: 0.49‚Ä≥ üü°Good
   üìã Sub-sessions: 2
     #1: 23:55‚Üí00:58 (1h 12m) | 6√ó600s
          üìà Guide: 0.50‚Ä≥ üü°Good
          üîß HFR: 2.65 ‚Üí 3.46 (avg 2.97)
          üìê FWHM: 3.18 ‚Üí 4.15 (avg 3.56)
          ‚≠ê Stars: 579 ‚Üí 581 (avg 580, consistency 1.00)
     #2: 04:20‚Üí05:15 (1h 5m) | 6√ó600s
          üìà Guide: 0.48‚Ä≥ üü°Good
          üîß HFR: 3.27 ‚Üí 5.31 (avg 4.27)
          üìê FWHM: 3.92 ‚Üí 6.38 (avg 5.12)
          ‚≠ê Stars: 532 ‚Üí 560 (avg 545, consistency 0.98)

üéØ **Autofocus Summary**
üîÑ Sessions: 20
üå°Ô∏è Average Temperature: 9.0¬∞C
üìà Focus Stability: Frequent adjustments

‚ö†Ô∏è **Issues & Alerts**
‚ùå Aborted Captures: 7
```

### üî¨ **DETAILED** - Data Analysis Mode
```
**üî≠ Session Overview (1/3)**
üìÖ 2025-09-05 07:32 UTC

üåô **Session Overview**
üì∏ Total Captures: 33
‚è∞ Duration: 22:16 ‚Üí 06:11 (7h 54m)
üå°Ô∏è Temperature: 7.6¬∞C ‚Üí 11.7¬∞C (avg 8.6¬∞C) (Stability: 0%)
üéØ Objects: 1 | üîç Filters: 3 (H, O, S)

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Moderate (Œî4.1¬∞C)

üåü **Guiding Performance**
üìä Measurements: 6130
üéØ Avg Error: 0.51‚Ä≥
üü° Guide Quality: Good
üìà RA: 0.38‚Ä≥ | DEC: 0.27‚Ä≥

üéØ **Autofocus Summary**
üîÑ Sessions: 20
üå°Ô∏è Average Temperature: 9.0¬∞C
üìà Focus Stability: Frequent adjustments

üìä **Image Quality Analysis**
üîß HFR: 1.87 ‚Üí 5.31 (avg 2.71)
üëÅÔ∏è Seeing Conditions: Good

‚ö†Ô∏è **Issues & Alerts**
‚ùå Aborted Captures: 7
üö® High HFR detected: 5.31 pixels (consider refocusing)

**üìä Performance Analysis (2/3)**

üéØ **Filter Performance Summary**

üìå **H**: 12√ó600s (2.3h) - üîß 3.62 | üìà 0.49‚Ä≥ üü°
üìå **O**: 10√ó600s (1.8h) - üîß 2.31 | üìà 0.52‚Ä≥ üü°
üìå **S**: 11√ó600s (2.1h) - üîß 2.08 | üìà 0.50‚Ä≥ üü°

**üî¨ Detailed Sub-Sessions (3/3)**

üìå H Filter (12√ó600s, 2h 18m)
üìã Sub-sessions: 2
     #1: 23:55‚Üí00:58 (1h 12m) | 6√ó600s
          üìà Guide: 0.50‚Ä≥ üü°Good
          üîß HFR: 2.65 ‚Üí 3.46 (avg 2.97)
          üìê FWHM: 3.18 ‚Üí 4.15 (avg 3.56)
          ‚≠ê Stars: 579 ‚Üí 581 (avg 580, consistency 1.00)
     #2: 04:20‚Üí05:15 (1h 5m) | 6√ó600s
          üìà Guide: 0.48‚Ä≥ üü°Good
          üîß HFR: 3.27 ‚Üí 5.31 (avg 4.27)
          üìê FWHM: 3.92 ‚Üí 6.38 (avg 5.12)
          ‚≠ê Stars: 532 ‚Üí 560 (avg 545, consistency 0.98)

üìå S Filter (11√ó600s, 2h 3m)
üìã Sub-sessions: 2
     #1: 22:53‚Üí23:40 (58m) | 5√ó600s
          üìà Guide: 0.52‚Ä≥ üü°Good
          üîß HFR: 1.90 ‚Üí 2.41 (avg 2.04)
          üìê FWHM: 2.28 ‚Üí 2.89 (avg 2.44)
          ‚≠ê Stars: 564 ‚Üí 571 (avg 568, consistency 1.00)
     #2: 03:07‚Üí04:02 (1h 5m) | 6√ó600s
          üìà Guide: 0.49‚Ä≥ üü°Good
          üîß HFR: 2.03 ‚Üí 2.18 (avg 2.11)
          üìê FWHM: 2.44 ‚Üí 2.61 (avg 2.53)
          ‚≠ê Stars: 543 ‚Üí 569 (avg 556, consistency 0.98)

üìå O Filter (10√ó600s, 1h 49m)
üìã Sub-sessions: 2
     #1: 01:16‚Üí02:11 (1h 5m) | 6√ó600s
          üìà Guide: 0.47‚Ä≥ üü°Good
          üîß HFR: 1.87 ‚Üí 2.21 (avg 2.05)
          üìê FWHM: 2.25 ‚Üí 2.65 (avg 2.46)
          ‚≠ê Stars: 634 ‚Üí 643 (avg 638, consistency 1.00)
     #2: 05:36‚Üí06:10 (44m) | 4√ó600s
          üìà Guide: 0.60‚Ä≥ üü°Good
          üîß HFR: 2.63 ‚Üí 2.78 (avg 2.69)
          üìê FWHM: 3.16 ‚Üí 3.34 (avg 3.23)
          ‚≠ê Stars: 519 ‚Üí 520 (avg 519, consistency 1.00)

ü§ñ **Analysis & Recommendations**
üö® High HFR detected: 5.31 pixels (consider refocusing)
```

## üìã Requirements

- Python 3.7+
- KStars/Ekos configured to generate analyze files
- Discord webhook configured
- **For DETAILED level**: NumPy/SciPy for advanced analytics
- **For plotting**: matplotlib (optional)

## üõ†Ô∏è Prerequisites

### Installing Pipenv

This project uses **Pipenv** for dependency management. If you don't have pipenv installed, here's how to install it:

#### Ubuntu/Debian
```bash
# Method 1: Using apt (recommended for system-wide installation)
sudo apt update
sudo apt install pipenv

# Method 2: Using pip (if you prefer pip)
sudo apt install python3-pip
pip3 install --user pipenv

# Method 3: Using the official installer
curl https://raw.githubusercontent.com/pypa/pipenv/master/get-pipenv.py | python3
```

#### Other Linux Distributions
```bash
# Fedora/CentOS/RHEL
sudo dnf install pipenv
# or
sudo yum install pipenv

# Arch Linux
sudo pacman -S python-pipenv

# Using pip (universal)
pip3 install --user pipenv
```

#### Verify Installation
```bash
pipenv --version
# Should output something like: pipenv, version 2023.x.x
```

**Note for Ubuntu/Debian users**: If you installed pipenv with `pip3 install --user`, you may need to add `~/.local/bin` to your PATH:
```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

## üöÄ Installation

1. **Clone the repository**
```bash
git clone https://github.com/grm/ekos-session-analyzer
cd ekos-session-analyzer
```

2. **Install dependencies**
```bash
# Basic installation (minimal & standard levels)
pipenv install

# For detailed level with advanced analytics
pipenv install numpy scipy

# For temporal plots (optional)
pipenv install matplotlib
```

3. **Configure the application**
```bash
# Copy example configuration
cp config_example.yml config.yml

# Edit config.yml with your settings
```

## ‚öôÔ∏è Configuration

### Basic Configuration

Edit the `config.yml` file:

```yaml
# Discord webhook URL (required)
webhook: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

# Time window in hours to analyze sessions
hours: 24

# Path to Ekos analyze files (optional)
# Default: ~/.local/share/kstars/analyze
analyze_dir: "/home/username/.local/share/kstars/analyze"

# Report level: minimal, standard, detailed
discord_report_level: "standard"

# Enable temporal plotting (optional)
plotting:
  enabled: true

# Log level (optional)
log_level: "INFO"
```

### üéØ Pixel Scale Configuration (HIGHLY RECOMMENDED)

**NEW FEATURE**: Configure your equipment's pixel scale for dramatically more accurate guiding quality assessment!

```yaml
# Imaging setup configuration for accurate guiding assessment
imaging_setup:
  # Pixel scale in arcseconds per pixel
  # Calculate as: (206265 √ó pixel_size_Œºm) √∑ (focal_length_mm √ó binning)
  pixel_scale_arcsec: 1.0  # CHANGE THIS to match your setup
  
  # Optional: Equipment names for logging
  telescope: "Your Telescope"
  camera: "Your Camera"

# Guide quality thresholds (in pixels - much more accurate!)
alert_thresholds:
  guide_quality:
    excellent_px: 0.5    # < 0.5 pixels = Excellent
    good_px: 1.0         # < 1.0 pixels = Good  
    average_px: 1.5      # < 1.5 pixels = Average
    # > 1.5 pixels = Poor
```

#### üìè How to Find Your Pixel Scale

**Method 1: Calculate from Equipment Specs**
```
Pixel Scale = (206.265 √ó pixel_size_Œºm) √∑ (focal_length_mm √ó binning)
```

**Method 2: From Plate Solving Software**
- **ASTAP**: Check image solving results
- **PlateSolve2**: Look in FITS header for CDELT1/CDELT2
- **ANSVR**: Check solving logs or image properties
- **Ekos/KStars**: View solved image properties in the Image tab

**Method 3: Online Calculators**
- Use tools like Astronomy.tools Field of View calculator (https://astronomy.tools/calculators/ccd_suitability)
- Enter telescope focal length and camera pixel size

#### üîç Finding Equipment Specifications

**Camera Pixel Size** (common values):
- **ASI183MC/MM**: 2.4Œºm
- **ASI294MC/MM**: 4.63Œºm  
- **ASI2600MC/MM**: 3.76Œºm
- **Canon 6D**: 5.36Œºm
- **Nikon D750**: 5.95Œºm
- **QHY600**: 3.76Œºm

**Telescope Focal Length**:
- Check manufacturer specs or measure via plate solving
- **Celestron C8**: 2032mm (f/10), 1280mm (f/6.3 with reducer)
- **Celestron C11**: 2800mm (f/10), 1764mm (f/6.3 with reducer)  
- **FSQ85**: 450mm
- **FSQ106**: 530mm
- **Takahashi TOA150**: 1095mm

#### üìä Common Setup Examples

```yaml
# High Resolution Setup
# Celestron C8 f/6.3 (1280mm) + ASI183MC (2.4Œºm)
pixel_scale_arcsec: 0.39

# Medium Resolution Setup  
# FSQ85 (450mm) + ASI294MC (4.63Œºm)
pixel_scale_arcsec: 2.12

# Wide Field Setup
# 200mm lens f/2.8 + Canon 6D (5.36Œºm)
pixel_scale_arcsec: 5.52

# Ultra High Resolution
# C11 f/10 (2800mm) + ASI183MC (2.4Œºm)
pixel_scale_arcsec: 0.18
```

### Advanced Options (Optional)

```yaml
# Advanced analytics (auto-enabled for detailed level)
advanced_analytics:
  enabled: false  # Set to true to force enable for standard level

# Alert thresholds (optional customization)
alert_thresholds:
  hfr_drift_warning: 0.5        # pixels
  temperature_swing_warning: 5.0 # ¬∞C
  success_rate_warning: 0.8     # 80%

# Notification preferences
notifications:
  performance_alerts: true
  min_captures_for_report: 1
```

## üîß Usage

### Development and Testing
```bash
# Safe testing with dry-run (RECOMMENDED)
pipenv run python nightly_summary.py -c config.yml --dry-run

# Verbose mode for debugging
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Production Use
```bash
# Send summary to Discord
pipenv run python nightly_summary.py -c config.yml

# With verbose output
pipenv run python nightly_summary.py -c config.yml --verbose
```

### Automation
Add to your crontab for daily summary at 8 AM:
```bash
0 8 * * * cd /path/to/ekos-session-analyzer && pipenv run python nightly_summary.py -c config.yml
```

## üìä Example Output

### Discord Message with Temporal Plot

Here's an example of what gets sent to Discord, including both the comprehensive text summary and temporal visualization from a real NGC 7380 session:

![Latest Session Plot](latest_session_plot.png)

The temporal plot shows:
- **üîß HFR Evolution**: Focus quality changes over time with autofocus events marked
- **üìà Guiding Performance**: Mount tracking stability with quality zones
- **üå°Ô∏è Temperature Evolution**: Environmental conditions during the session

## üîç Troubleshooting

### No Data Found
- Verify that KStars/Ekos generates `.analyze` files in `~/.local/share/kstars/analyze/`
- Check the `analyze_dir` path in configuration
- Use `--verbose` to see detailed logs

### Discord Webhook Error
- Verify the webhook URL in `config.yml`
- Test with `--dry-run` first to see formatted output

### Advanced Analytics Issues
- For DETAILED level, install: `pipenv install numpy scipy`
- The system gracefully falls back to basic mode if dependencies are missing
- Check console output for "advanced analytics" vs "basic analytics"

### Plotting Issues
- Install matplotlib: `pipenv install matplotlib`
- Check `plotting.enabled: true` in configuration
- Plots are saved to `plots/` directory and attached to Discord messages

### Parsing Issues
- Check KStars/Ekos version (tested with 3.7.7+)
- Enable verbose mode: `--verbose`
- Use dry-run for safe testing: `--dry-run`

## üéØ Use Cases

### **Quick Monitoring** ‚Üí MINIMAL Level
- Essential notifications for automation
- Critical alerts only
- Perfect for mobile notifications and monitoring systems

### **Daily Usage** ‚Üí STANDARD Level (Default)
- Comprehensive session summaries
- All essential astrophotography metrics
- Balanced information without complexity

### **Data Analysis** ‚Üí DETAILED Level  
- In-depth statistical analysis with sub-sessions
- Quality and performance optimization insights
- Scientific metrics with correlation analysis
- Advanced troubleshooting information

## üî¨ Advanced Analytics (DETAILED Level)

### Automatic Features
When you select `discord_report_level: "detailed"`, the system automatically enables:

- **Sub-Session Analysis**: Detailed breakdown of each imaging run by filter
- **Statistical Correlations**: Temperature-HFR analysis with significance testing
- **Quality Scoring**: Objective analysis of session quality and conditions
- **Performance Metrics**: Success rates and filter-specific efficiency analysis
- **Trend Analysis**: HFR stability and degradation detection
- **Intelligent Alerts**: Automatic detection of issues with actionable recommendations

### Dependencies
The detailed level requires scientific Python libraries:
```bash
pipenv install numpy scipy
```

## üß™ Development

### Safe Testing
Always use dry-run mode during development:
```bash
# Test without sending to Discord
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Architecture
- **nightly_summary.py**: CLI interface and orchestration
- **ekos_analyzer.py**: Ekos .analyze file parser and data extraction
- **ekos_discord_formatter.py**: Unified Discord message formatter for all levels
- **session_plotter.py**: Temporal plot generation with matplotlib
- **advanced_metrics.py**: Statistical calculations and quality analysis
- **utils.py**: Configuration, logging, and Discord utilities

## ü§ù Contributing

Contributions are welcome! The project uses:
- **Python 3.7+** with Pipenv for dependency management
- **NumPy/SciPy** for advanced analytics (optional)
- **matplotlib** for temporal plotting (optional)
- **Clear separation** between basic and advanced features with graceful degradation

## üìÑ License

This project is under MIT license. See LICENSE file for details.

## üôè Acknowledgments

- KStars/Ekos team for excellent astrophotography software
- Discord community for feedback and suggestions
- NumPy/SciPy communities for statistical computing tools

## üöÄ Latest Updates

- **üéØ Pixel-Scale-Based Guiding Quality**: Revolutionary improvement in guiding assessment accuracy! Configure your equipment's pixel scale for meaningful quality ratings instead of misleading fixed thresholds.
- **Enhanced Multi-Filter Analysis**: Comprehensive sub-session breakdown by filter
- **Improved Guiding Analytics**: Real-time guiding performance analysis with quality assessment
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Temporal Plotting System**: HFR, guiding, and temperature evolution graphs with pixel-scale-accurate quality zones
- **Advanced Statistical Analysis**: Temperature correlations and quality metrics
- **Better Error Handling**: Graceful degradation and clear error messages
- **Unified Configuration**: Single config file supporting all features and levels

Perfect for astrophotographers from beginners to data enthusiasts! üî≠‚ú®
