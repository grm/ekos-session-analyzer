# Ekos Session Analyzer

Astrophotography session analyzer specialized for **Ekos/KStars**. This application analyzes `.analyze` files generated by Ekos and sends comprehensive summaries with **temporal plots** to Discord.

## üåü Features

### Core Features
- **Native Ekos Analysis**: Directly parses KStars/Ekos `.analyze` files
- **Temporal Plotting**: HFR, guiding error, and temperature evolution graphs
- **Advanced Analytics**: Statistical analysis with numpy/scipy (optional)
- **3 Report Levels**: minimal, standard, detailed - from quick notifications to comprehensive analysis
- **Discord Integration**: Rich summaries with emojis and organized statistics
- **Dry-Run Mode**: Safe testing without sending to Discord

### Advanced Features
- **Multi-Filter Analysis**: Performance breakdown by filter with sub-session details
- **Pixel-Scale-Based Guiding Quality**: Accurate guiding assessment based on YOUR specific equipment
- **Guiding Analytics**: Comprehensive guiding performance analysis by filter
- **Quality Metrics**: HFR, FWHM, star detection, and seeing conditions
- **Temperature Correlation**: Statistical analysis of temperature effects on imaging quality
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Alert System**: Automatic detection of performance issues and recommendations

## üìä Report Levels

### üì± **MINIMAL** - Quick Notifications
```
**üî≠ Session Summary (Minimal)**
üì∏ **31 captures completed**
‚è∞ Duration: 5h 55m

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Variable (Œî5.1¬∞C)
üî≠ Mount Tracking: Good (28 events)

üéØ **Autofocus Summary**
üîÑ Sessions: 9
üìà Focus Stability: Frequent adjustments

üö® **4 Critical Issues**
‚Ä¢ 4 aborted captures detected
```

### üìä **STANDARD** - Daily Usage (Default)
```
**üî≠ Ekos Session Summary**
üìÖ 2024-01-15 18:12 UTC

üåô **Session Overview**
üì∏ Total Captures: 31
‚è∞ Duration: 11:41 ‚Üí 17:37 (5h 55m)
üå°Ô∏è Temperature: 15.8¬∞C ‚Üí 20.9¬∞C (avg 17.0¬∞C)
üéØ Objects: 1 | üîç Filters: 3 (H, O, S)

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Variable (Œî5.1¬∞C)
üî≠ Mount Tracking: Good (28 events)

üåü **Guiding Performance**
üìä Measurements: 1,247
üéØ Avg Error: 0.92‚Ä≥
üü° Guide Quality: Good
üìà RA: 0.78‚Ä≥ | DEC: 0.61‚Ä≥

üìä **Capture Details**

üéØ **NGC 7380**
üìå H Filter (11√ó600s, 1h 50m)
   üîß HFR: 3.60 ‚Üí 5.62 (avg 4.64, œÉ 0.66)
   üìê FWHM: 8.46 ‚Üí 13.21 (avg 10.90, œÉ 1.55)
   ‚≠ê Stars: 249 ‚Üí 250 (avg 250, consistency 1.00)
   üìà Guide: 0.89‚Ä≥ üü°Good

üéØ **Autofocus Summary**
üîÑ Sessions: 9
üå°Ô∏è Average Temperature: 17.1¬∞C
üìà Focus Stability: Frequent adjustments

‚ö†Ô∏è **Issues & Alerts**
‚ùå Aborted Captures: 4
```

### üî¨ **DETAILED** - Data Analysis Mode
```
**üî≠ Session Overview (1/3)**
üìÖ 2024-01-15 18:12 UTC

üåô **Session Overview**
üì∏ Total Captures: 31
‚è∞ Duration: 11:41 ‚Üí 17:37 (5h 55m)
üå°Ô∏è Temperature: 15.8¬∞C ‚Üí 20.9¬∞C (avg 17.0¬∞C) (Stability: 60%)
üéØ Objects: 1 | üîç Filters: 3 (H, O, S)

üå§Ô∏è **Session Conditions**
üå°Ô∏è Temperature Stability: Variable (Œî5.1¬∞C)
üî≠ Mount Tracking: Good (28 events)

üåü **Guiding Performance**
üìä Measurements: 1,247
üéØ Avg Error: 0.92‚Ä≥
üü° Guide Quality: Good
üìà RA: 0.78‚Ä≥ | DEC: 0.61‚Ä≥

üìä **Image Quality Analysis**
üîß HFR: 1.96 ‚Üí 5.62 (avg 3.06)
üëÅÔ∏è Seeing Conditions: Average
üìà HFR Stability: 0.215 (lower is better)

**üìä Performance Analysis (2/3)**

üéØ **Filter Performance Summary**

üìå **H**: 11√ó600s (1.8h) - üîß 4.64 | üìà 0.89‚Ä≥ üü°
üìå **O**: 13√ó600s (2.2h) - üîß 2.83 | üìà 0.95‚Ä≥ üü°  
üìå **S**: 7√ó600s (1.2h) - üîß 2.41 | üìà 0.91‚Ä≥ üü°

**üî¨ Detailed Sub-Sessions (3/3)**

üéØ **NGC 7380**
üìå H Filter (11√ó600s, 1h 50m)
üìã Sub-sessions: 2
     #1: 22:46‚Üí23:57 (1h 10m) | 7√ó600s
          üìà Guide: 0.94‚Ä≥ üü°Good
          üîß HFR: 4.12 ‚Üí 5.62 (avg 4.89)
          üìê FWHM: 4.94 ‚Üí 6.74 (avg 5.87)
         ‚≠ê Stars: 249 ‚Üí 250 (avg 250, consistency 1.00)
     #2: 00:15‚Üí00:55 (40m) | 4√ó600s
          üìà Guide: 0.81‚Ä≥ üü°Good
          üîß HFR: 3.60 ‚Üí 4.98 (avg 4.22)
          üìê FWHM: 4.32 ‚Üí 5.98 (avg 5.06)
         ‚≠ê Stars: 249 ‚Üí 250 (avg 250, consistency 1.00)

üå°Ô∏è **Temperature Analysis**
üìä Thermal Stability: 60% (Range: 5.1¬∞C)
üìà Temp-HFR Correlation: -0.234 (significant)

üéØ **Autofocus Analysis**
üîÑ Sessions: 9
üîç **By Filter:**
   ‚Ä¢ H: 3 sessions (avg temp 16.8¬∞C)
   ‚Ä¢ O: 4 sessions (avg temp 17.2¬∞C)
   ‚Ä¢ S: 2 sessions (avg temp 17.5¬∞C)
‚è±Ô∏è Avg Interval: 45 minutes
```

## üìã Requirements

- Python 3.7+
- KStars/Ekos configured to generate analyze files
- Discord webhook configured
- **For DETAILED level**: NumPy/SciPy for advanced analytics
- **For plotting**: matplotlib (optional)

## üõ†Ô∏è Prerequisites

### Installing Pipenv

This project uses **Pipenv** for dependency management. If you don't have pipenv installed, here's how to install it:

#### Ubuntu/Debian
```bash
# Method 1: Using apt (recommended for system-wide installation)
sudo apt update
sudo apt install pipenv

# Method 2: Using pip (if you prefer pip)
sudo apt install python3-pip
pip3 install --user pipenv

# Method 3: Using the official installer
curl https://raw.githubusercontent.com/pypa/pipenv/master/get-pipenv.py | python3
```

#### Other Linux Distributions
```bash
# Fedora/CentOS/RHEL
sudo dnf install pipenv
# or
sudo yum install pipenv

# Arch Linux
sudo pacman -S python-pipenv

# Using pip (universal)
pip3 install --user pipenv
```

#### Verify Installation
```bash
pipenv --version
# Should output something like: pipenv, version 2023.x.x
```

**Note for Ubuntu/Debian users**: If you installed pipenv with `pip3 install --user`, you may need to add `~/.local/bin` to your PATH:
```bash
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

## üöÄ Installation

1. **Clone the repository**
```bash
git clone https://github.com/grm/ekos-session-analyzer
cd ekos-session-analyzer
```

2. **Install dependencies**
```bash
# Basic installation (minimal & standard levels)
pipenv install

# For detailed level with advanced analytics
pipenv install numpy scipy

# For temporal plots (optional)
pipenv install matplotlib
```

3. **Configure the application**
```bash
# Copy example configuration
cp config_example.yml config.yml

# Edit config.yml with your settings
```

## ‚öôÔ∏è Configuration

### Basic Configuration

Edit the `config.yml` file:

```yaml
# Discord webhook URL (required)
webhook: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

# Time window in hours to analyze sessions
hours: 24

# Path to Ekos analyze files (optional)
# Default: ~/.local/share/kstars/analyze
analyze_dir: "/home/username/.local/share/kstars/analyze"

# Report level: minimal, standard, detailed
discord_report_level: "standard"

# Enable temporal plotting (optional)
plotting:
  enabled: true

# Log level (optional)
log_level: "INFO"
```

### üéØ Pixel Scale Configuration (HIGHLY RECOMMENDED)

**NEW FEATURE**: Configure your equipment's pixel scale for dramatically more accurate guiding quality assessment!

```yaml
# Imaging setup configuration for accurate guiding assessment
imaging_setup:
  # Pixel scale in arcseconds per pixel
  # Calculate as: (206265 √ó pixel_size_Œºm) √∑ (focal_length_mm √ó binning)
  pixel_scale_arcsec: 1.0  # CHANGE THIS to match your setup
  
  # Optional: Equipment names for logging
  telescope: "Your Telescope"
  camera: "Your Camera"

# Guide quality thresholds (in pixels - much more accurate!)
alert_thresholds:
  guide_quality:
    excellent_px: 0.5    # < 0.5 pixels = Excellent
    good_px: 1.0         # < 1.0 pixels = Good  
    average_px: 1.5      # < 1.5 pixels = Average
    # > 1.5 pixels = Poor
```

#### üìè How to Find Your Pixel Scale

**Method 1: Calculate from Equipment Specs**
```
Pixel Scale = (206265 √ó pixel_size_Œºm) √∑ (focal_length_mm √ó binning)
```

**Method 2: From Plate Solving Software**
- **ASTAP**: Check image solving results
- **PlateSolve2**: Look in FITS header for CDELT1/CDELT2
- **ANSVR**: Check solving logs or image properties
- **Ekos/KStars**: View solved image properties in the Image tab

**Method 3: Online Calculators**
- Use tools like AstroBin's Field of View calculator
- Enter telescope focal length and camera pixel size

#### üîç Finding Equipment Specifications

**Camera Pixel Size** (common values):
- **ASI183MC/MM**: 2.4Œºm
- **ASI294MC/MM**: 4.63Œºm  
- **ASI2600MC/MM**: 3.76Œºm
- **Canon 6D**: 5.36Œºm
- **Nikon D750**: 5.95Œºm
- **QHY600**: 3.76Œºm

**Telescope Focal Length**:
- Check manufacturer specs or measure via plate solving
- **Celestron C8**: 2032mm (f/10), 1280mm (f/6.3 with reducer)
- **Celestron C11**: 2800mm (f/10), 1764mm (f/6.3 with reducer)  
- **FSQ85**: 450mm
- **FSQ106**: 530mm
- **Takahashi TOA150**: 1095mm

#### üìä Common Setup Examples

```yaml
# High Resolution Setup
# Celestron C8 f/6.3 (1280mm) + ASI183MC (2.4Œºm)
pixel_scale_arcsec: 0.39

# Medium Resolution Setup  
# FSQ85 (450mm) + ASI294MC (4.63Œºm)
pixel_scale_arcsec: 2.12

# Wide Field Setup
# 200mm lens f/2.8 + Canon 6D (5.36Œºm)
pixel_scale_arcsec: 5.52

# Ultra High Resolution
# C11 f/10 (2800mm) + ASI183MC (2.4Œºm)
pixel_scale_arcsec: 0.18
```

### Advanced Options (Optional)

```yaml
# Advanced analytics (auto-enabled for detailed level)
advanced_analytics:
  enabled: false  # Set to true to force enable for standard level

# Alert thresholds (optional customization)
alert_thresholds:
  hfr_drift_warning: 0.5        # pixels
  temperature_swing_warning: 5.0 # ¬∞C
  success_rate_warning: 0.8     # 80%

# Notification preferences
notifications:
  performance_alerts: true
  min_captures_for_report: 1
```

## üîß Usage

### Development and Testing
```bash
# Safe testing with dry-run (RECOMMENDED)
pipenv run python nightly_summary.py -c config.yml --dry-run

# Verbose mode for debugging
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Production Use
```bash
# Send summary to Discord
pipenv run python nightly_summary.py -c config.yml

# With verbose output
pipenv run python nightly_summary.py -c config.yml --verbose
```

### Automation
Add to your crontab for daily summary at 8 AM:
```bash
0 8 * * * cd /path/to/ekos-session-analyzer && pipenv run python nightly_summary.py -c config.yml
```

## üìä Example Output

### Discord Message with Temporal Plot

Here's an example of what gets sent to Discord, including both the comprehensive text summary and temporal visualization:

![Example Session Plot](example_plot.png)

**Example Discord Message:**
```
üî≠ Ekos Session Summary
üìÖ 2025-09-04 07:49 UTC

üåô Session Overview
üì∏ Total Captures: 7
‚è∞ Duration: 07:00 ‚Üí 08:38 (1h 38m)
üéØ Objects: 1 | üîç Filters: 3 (H, O, S)

üåü Guiding Performance
üìä Measurements: 22
üéØ Avg Error: 1.21‚Ä≥
üü° Guide Quality: Good
üìà RA: 0.95‚Ä≥ | DEC: 0.74‚Ä≥

üìä Capture Details

üéØ NGC 7380
üìå H Filter (4√ó600s, 58m)
   üîß HFR: 2.75 ‚Üí 4.10 (avg 3.42, œÉ 0.67)
   üìê FWHM: 6.46 ‚Üí 9.63 (avg 8.05, œÉ 1.59)
   ‚≠ê Stars: 244 ‚Üí 250 (avg 247, consistency 0.99)
   üìà Guide: 1.19‚Ä≥ üü°Good

üìå O Filter (2√ó600s, 20m)
   üîß HFR: 2.25 ‚Üí 2.25 (avg 2.25, œÉ 0.00)
   üìê FWHM: 5.29 ‚Üí 5.29 (avg 5.29, œÉ 0.00)
   ‚≠ê Stars: 247 ‚Üí 248 (avg 248, consistency 1.00)
   üìà Guide: 1.24‚Ä≥ üü°Good

üéØ Autofocus Summary
üîÑ Sessions: 3
üìà Focus Stability: Good

‚ö†Ô∏è Issues & Alerts
‚ùå Aborted Captures: 4
```

The temporal plot shows:
- **üîß HFR Evolution**: Focus quality changes over time with autofocus events marked
- **üìà Guiding Performance**: Mount tracking stability with quality zones
- **üå°Ô∏è Temperature Evolution**: Environmental conditions during the session

## üîç Troubleshooting

### No Data Found
- Verify that KStars/Ekos generates `.analyze` files in `~/.local/share/kstars/analyze/`
- Check the `analyze_dir` path in configuration
- Use `--verbose` to see detailed logs

### Discord Webhook Error
- Verify the webhook URL in `config.yml`
- Test with `--dry-run` first to see formatted output

### Advanced Analytics Issues
- For DETAILED level, install: `pipenv install numpy scipy`
- The system gracefully falls back to basic mode if dependencies are missing
- Check console output for "advanced analytics" vs "basic analytics"

### Plotting Issues
- Install matplotlib: `pipenv install matplotlib`
- Check `plotting.enabled: true` in configuration
- Plots are saved to `plots/` directory and attached to Discord messages

### Parsing Issues
- Check KStars/Ekos version (tested with 3.7.7+)
- Enable verbose mode: `--verbose`
- Use dry-run for safe testing: `--dry-run`

## üéØ Use Cases

### **Quick Monitoring** ‚Üí MINIMAL Level
- Essential notifications for automation
- Critical alerts only
- Perfect for mobile notifications and monitoring systems

### **Daily Usage** ‚Üí STANDARD Level (Default)
- Comprehensive session summaries
- All essential astrophotography metrics
- Balanced information without complexity

### **Data Analysis** ‚Üí DETAILED Level  
- In-depth statistical analysis with sub-sessions
- Quality and performance optimization insights
- Scientific metrics with correlation analysis
- Advanced troubleshooting information

## üî¨ Advanced Analytics (DETAILED Level)

### Automatic Features
When you select `discord_report_level: "detailed"`, the system automatically enables:

- **Sub-Session Analysis**: Detailed breakdown of each imaging run by filter
- **Statistical Correlations**: Temperature-HFR analysis with significance testing
- **Quality Scoring**: Objective analysis of session quality and conditions
- **Performance Metrics**: Success rates and filter-specific efficiency analysis
- **Trend Analysis**: HFR stability and degradation detection
- **Intelligent Alerts**: Automatic detection of issues with actionable recommendations

### Dependencies
The detailed level requires scientific Python libraries:
```bash
pipenv install numpy scipy
```

## üß™ Development

### Safe Testing
Always use dry-run mode during development:
```bash
# Test without sending to Discord
pipenv run python nightly_summary.py -c config.yml --dry-run --verbose
```

### Architecture
- **nightly_summary.py**: CLI interface and orchestration
- **ekos_analyzer.py**: Ekos .analyze file parser and data extraction
- **ekos_discord_formatter.py**: Unified Discord message formatter for all levels
- **session_plotter.py**: Temporal plot generation with matplotlib
- **advanced_metrics.py**: Statistical calculations and quality analysis
- **utils.py**: Configuration, logging, and Discord utilities

## ü§ù Contributing

Contributions are welcome! The project uses:
- **Python 3.7+** with Pipenv for dependency management
- **NumPy/SciPy** for advanced analytics (optional)
- **matplotlib** for temporal plotting (optional)
- **Clear separation** between basic and advanced features with graceful degradation

## üìÑ License

This project is under MIT license. See LICENSE file for details.

## üôè Acknowledgments

- KStars/Ekos team for excellent astrophotography software
- Discord community for feedback and suggestions
- NumPy/SciPy communities for statistical computing tools

## üöÄ Latest Updates

- **üéØ Pixel-Scale-Based Guiding Quality**: Revolutionary improvement in guiding assessment accuracy! Configure your equipment's pixel scale for meaningful quality ratings instead of misleading fixed thresholds.
- **Enhanced Multi-Filter Analysis**: Comprehensive sub-session breakdown by filter
- **Improved Guiding Analytics**: Real-time guiding performance analysis with quality assessment
- **Intelligent Message Splitting**: Automatic Discord message fragmentation for large sessions
- **Temporal Plotting System**: HFR, guiding, and temperature evolution graphs with pixel-scale-accurate quality zones
- **Advanced Statistical Analysis**: Temperature correlations and quality metrics
- **Better Error Handling**: Graceful degradation and clear error messages
- **Unified Configuration**: Single config file supporting all features and levels

Perfect for astrophotographers from beginners to data enthusiasts! üî≠‚ú®
